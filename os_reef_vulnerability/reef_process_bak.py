#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Mon Oct 26 10:29:40 2020

@author: verwirrt
"""

import pandas as pd;
import numpy as np;
from os import path;
from netCDF4 import Dataset;
from string import Template;
import datetime;
import matplotlib.pyplot as plt;

import osoda_global_settings;

def get_reef_name(reefID, reefbaseData):
    reefRow = reefbaseData[reefbaseData["ID"] == reefID].iloc[0]
    return reefRow["REEF_NAME"], reefRow["LON"], reefRow["LAT"];
    

settings = osoda_global_settings.get_default_settings();
reefSummaryPathTemplate = Template(path.join(settings["outputPathRoot"], "reef_outputs", "all_reef_${VAR}_summary_metrics.csv"));
indivReefDataTemplate = Template(path.join(settings["outputPathRoot"], "reef_outputs", "individual_${REGION}", "reef_${REEFID}.csv"));
vulnerableReefsOutputPath = path.join(settings["outputPathRoot"], "reef_outputs", "vulnerable_reefs.csv");
plotPath = "../output/reef_outputs/plots";
reefLocationsPath = "../reefbase/ReefLocations.csv";

reefbaseData = pd.read_csv(reefLocationsPath, sep=",", encoding="ISO-8859-1");

figsize=(12, 6);
fontsize=16;

#colours
midGrey = (0.5, 0.5, 0.5);


#Read DIC summary metrics and plot the mean, range and uncertainties for all reefs
#ordered by range
reefMetrics = pd.read_csv(reefSummaryPathTemplate.safe_substitute(VAR="DIC"));
reefMetrics = reefMetrics.dropna();
reefMetrics = reefMetrics.sort_values(by="annual_range_mean", ascending=False);


#select vulnerable reefsreefs in the lower quartile (bottom 25%) when ranked by mean annual DIC range
vulnerableThresholdIndex = int(np.round(len(reefMetrics)*(1.0-0.25))); #already in reverse range order
vulnerableReefs = reefMetrics.iloc[vulnerableThresholdIndex:];
vulnerableReefs.to_csv(vulnerableReefsOutputPath, sep=",", index=False);


#SORT BY RANGE
x = np.arange(0, len(reefMetrics));
plt.figure(figsize=figsize);
plt.errorbar(x, reefMetrics["annual_max_mean"], yerr=reefMetrics["annual_max_sd"], ls="none", c=midGrey);
plt.scatter(x, reefMetrics["annual_max_mean"], c=midGrey);
plt.errorbar(x, reefMetrics["annual_min_mean"], yerr=reefMetrics["annual_min_sd"], ls="none", c=midGrey);
plt.scatter(x, reefMetrics["annual_min_mean"], c=midGrey);
plt.errorbar(x, reefMetrics["mean"], yerr=reefMetrics["sd"], ls="none", alpha=0.6);
plt.scatter(x, reefMetrics["mean"]);
ax = plt.gca();
plt.plot([vulnerableThresholdIndex, vulnerableThresholdIndex], [ax.get_ylim()[0], ax.get_ylim()[1]], 'r:', linewidth=2);

plt.ylabel(r"mean and range of annual DIC ($\mu$mol/kg)", fontsize=fontsize);
plt.xlabel("reef order", fontsize=fontsize);
plt.tick_params(labelsize=fontsize);
plt.tight_layout();
plt.savefig(path.join(plotPath, "ordered_DIC_range.pdf"));
plt.savefig(path.join(plotPath, "ordered_DIC_range.png"));



#Plot example time series
#selectedReefs = [2, 5, 10, 275, 300, 320, 325, 330];
selectedReefs = [2, 5, 9, 320, 331];
plt.figure(figsize = figsize);
for reefIndex in selectedReefs:
    #get reef data
    reefName, reefLon, reefLat = get_reef_name(reefMetrics.iloc[reefIndex]["reef_id"], reefbaseData);
    reefLabel = "{0} ({1}, {2})".format(reefName, reefLon, reefLat);
    reefTimeseriesPath = indivReefDataTemplate.safe_substitute(REGION=reefMetrics.iloc[reefIndex]["region"], REEFID=int(reefMetrics.iloc[reefIndex]["reef_id"]));
    reefTimeseries = pd.read_csv(reefTimeseriesPath);
    time = [datetime.datetime(1980,1,1) + datetime.timedelta(seconds=t) for t in reefTimeseries["time_s_since_1980"]];
    ax = plt.gca();
    linePlot = ax.plot(time, reefTimeseries["DIC_pred"], label=reefLabel)[0];
    plt.fill_between(time, reefTimeseries["DIC_pred"]-reefTimeseries["DIC_pred_combined_uncertainty"], reefTimeseries["DIC_pred"]+reefTimeseries["DIC_pred_combined_uncertainty"], facecolor=linePlot.get_color(), alpha=0.3);
plt.xlim(datetime.datetime(2010,1,1), datetime.datetime(2019,1,1));
plt.legend(loc=0, fontsize=fontsize);
plt.xlabel("time (year)", fontsize=fontsize);
plt.ylabel("Surface water DIC ($\mu$mol/kg)", fontsize=fontsize);
plt.tick_params(labelsize=fontsize);
plt.savefig(path.join(plotPath, "example_reef_timeseries.pdf"));
plt.savefig(path.join(plotPath, "example_reef_timeseries.png"));













