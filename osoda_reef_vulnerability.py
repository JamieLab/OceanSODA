#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Sat Nov  7 09:50:18 2020

@author: tom holding
"""

from string import Template;
from os import path;
from os_reef_vulnerability.reef_timeseries import calculate_all_reef_metrics;
from os_reef_vulnerability.reef_process import extract_vulnerable_reefs;

def main(settings, useDistanceToLandMask=False):
    #Process and filter reefs based on region and land mask.
    #Extract DIC time series for each reef.
    #Calculate summary statistics for all reefs.
    reefBaseDataPath = settings["reefLocationsDataPath"];
    carbonateDataTemplate = settings["longGriddedTimeSeriesPathTemplate"];
    reefIndividualOutputsPathTemplate = Template(path.join(settings["outputPathRoot"], "reef_outputs", "individual_reefs", "individual_${REGION}/reef_${REEFID}.csv")); #Reef time series DIC data for individual reefs
    reefSummaryOutputsPathTemplate = Template(path.join(settings["outputPathRoot"], "reef_outputs", "all_reef_${SUMMARYVAR}_summary_metrics.csv")); #Reef summary statistic data
    calculate_all_reef_metrics(reefBaseDataPath, carbonateDataTemplate, reefIndividualOutputsPathTemplate, reefSummaryOutputsPathTemplate, useDistanceToLandMask=useDistanceToLandMask);

    #Apply threshold to coefficient of variance to select vulnerable reefs
    vulnerableReefsListOutputPath = path.join(settings["outputPathRoot"], "reef_outputs", "vulnerable_reef_list.csv");
    extract_vulnerable_reefs(reefIndividualOutputsPathTemplate, reefSummaryOutputsPathTemplate, vulnerableReefsListOutputPath);